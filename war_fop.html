<!DOCTYPE html>
<html>
<head>
	<title></title>
	<meta charset="UTF-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
	<meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://fonts.googleapis.com/css?family=Roboto" rel="stylesheet">
</head>

<body>
    <div id="veth" style="margin: 0 auto; max-width: 600px;"></div>
    <div id="kved1" style="margin: 0 auto; max-width: 600px;"></div>
    <div id="kved2" style="margin: 0 auto; max-width: 600px;"></div>
    <div id="kved3" style="margin: 0 auto; max-width: 600px;"></div>
    <div id="kved4" style="margin: 0 auto; max-width: 600px;"></div>
    <div id="kved5" style="margin: 0 auto; max-width: 600px;"></div>
    <div id="kved6" style="margin: 0 auto; max-width: 600px;"></div>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
    <script src="https://d3js.org/d3.v4.min.js"></script>

    <!-- <script src="https://cdn.jsdelivr.net/gh/liga-net/few-projects/highcharts_module/code/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/liga-net/few-projects/d3.v4.min.js"></script>
    <script src="https://firebasestorage.googleapis.com/v0/b/local-25117.appspot.com/o/amir.js?alt=media&token=bdf5e36c-c06d-41dc-9ac3-8bbb025316f0"></script> -->
    
    <script>
        function getData(id){
            var value = $.ajax({ 
                url: id, 
                async: false
            }).responseJSON;
            return value;
        }
        function numberWithSpaces(x) {
            return String(x).replace(/\B(?=(\d{3})+(?!\d))/g, " ");
        }
        var ukraine = getData('https://cdn.jsdelivr.net/gh/liga-net/few-projects/local_elections/ukraine.json');
        
        function makeMap(id,w) {
            if (w < 600) {
                var width = w,
                height = w/1.3,
                scale = w*4.4,
                from = 260827968,
                to = 14;
            } else {
                var width = 600,
                scale = 2800,
                from = 260827968,
                to = 18,
                height = 450;
            }
            var color = d3.scaleThreshold()
                .domain([-2959,-1859,-859, 859, 1859, 2859, 3859, 4859])
                .range(["#8c510a","#bf812d","#dfc27d","#f6e8c3","#c7eae5","#80cdc1","#35978f","#01665e"]);
            var albersProjection = d3.geoAlbers()
                .scale(scale)
                .rotate([-30.68,0])
                .center([0, 50.12])
                .translate( [width/2.2,height/3] );

            var geoPath = d3.geoPath()
                .projection(albersProjection);
            
            d3.select("#"+id).html('')
            
            var svg = d3.select("#"+id).append("svg")
                .attr("width", width)
                .attr("height", height);
            if (width > 500) {
                var fontSize = '18px'
            } else {
                var fontSize = '12px'
            }
            
            if (id == 'veth') {
                var json = [
                {"name":"Львівська область", "value":4859, "jur":1416},
                {"name":"Дніпропетровська область", "value":2436, "jur":986},
                {"name":"Одеська область", "value":681, "jur":828},
                {"name":"Київська область", "value":2435, "jur":789},
                {"name":"Харківська область", "value":1600, "jur":659},
                {"name":"Івано-Франківська область", "value":1313, "jur":487},
                {"name":"Закарпатська область", "value":918, "jur":433},
                {"name":"Запорізька область", "value":-37, "jur":366},
                {"name":"Хмельницька область", "value":1061, "jur":349},
                {"name":"Вінницька область", "value":1683, "jur":325},
                {"name":"Житомирська область", "value":832, "jur":292},
                {"name":"Полтавська область", "value":1085, "jur":289},
                {"name":"Чернівецька область", "value":706, "jur":282},
                {"name":"Тернопільська область", "value":929, "jur":280},
                {"name":"Волинська область", "value":1471, "jur":267},
                {"name":"Рівненська область", "value":1013, "jur":264},
                {"name":"Миколаївська область", "value":7, "jur":240},
                {"name":"Черкаська область", "value":932, "jur":211},
                {"name":"Кіровоградська область", "value":445, "jur":172},
                {"name":"Чернігівська область", "value":706, "jur":117},
                {"name":"Сумська область", "value":239, "jur":94},
                {"name":"Луганська область", "value":-1101, "jur":-61},
                {"name":"Херсонська область", "value":-719, "jur":-146},
                {"name":"Донецька область", "value":-2938, "jur":-218},
                {"name":"Автономна Республіка Крим", "value":null, "jur":null}]
                
                var title = 'Кількість нових ФОП'
                var tooltip1 = '<p>Приріст ФОП: '
                var tooltip2 = '<p>Приріст юридичних осіб: '
            } 
            svg.append("text")
                .attr("x", (width / 2) ) 
                .attr("y", 20)
                .attr("text-anchor", "middle")  
                .style("font-size", fontSize)
                .style("font-family", "Georgia")
                .text(title);
            var g = svg.append("g");
            
            var tooltipBee = d3.select("body")
                .append("div")
                .style("position", "absolute")
                .style("z-index", "10")
                .style("visibility", "hidden")
                .style("padding", "14px")
                .style("background-color", "white")
                .style("border", "1px solid #f5f5f5")
                .style("color", "black")
                .style("border-radius", "6px")
                .style("border-color", "black")
                .style("font", "12px sans-serif")
                .text("tooltip");
            
            g.selectAll("path")
                .data(ukraine.features)
                .enter()
                .append("path")
                .attr("fill", function(d) {
                    return color(json.filter(k => k.name == d.properties['name'])[0].value)
                })
                .attr("stroke", "#f5f5f5")
                .attr("stroke-width", ".1px")
                .attr("d", geoPath )
                .attr("class", "district")
                .on("mouseover", function(d) {
                    if (d.properties.name != 'Автономна Республіка Крим') {
                            tooltipBee.html(
                            '<h4>'+d.properties.name+'</h4>'+
                            tooltip1+String(numberWithSpaces(json.filter(k => k.name == d.properties['name'])[0].value))+'</p>'+
                            tooltip2+String(numberWithSpaces(json.filter(k => k.name == d.properties['name'])[0].jur))+'</p>'
                        )
                    } else {
                        tooltipBee.html(
                        '<h4>'+d.properties.name+'</h4>'+
                        '<p>Тимчасово окупована територія РФ</p>'
                    )
                    }
                    
                    var dist = d3.select(this)
                    dist.attr("stroke", "black")
                        .attr("stroke-width", "1.5px")
                    return tooltipBee.style("visibility", "visible")
                })
                .on("mousemove", function() {
                    return tooltipBee.style("top", (d3.event.pageY-10)+"px").style("left",(d3.event.pageX+10)+"px");
                })
                .on("mouseout", function(d){
                    var dist = d3.select(this)
                    dist.attr("stroke", "#f5f5f5")
                        .attr("stroke-width", ".1px")
                    return tooltipBee.style("visibility", "hidden");
                })
            var kyiv = [30.32,49.96]
            var projection = d3.geoMercator()
                .scale(scale)
                .rotate([-30.32,0])
                .center([0, 49.96])
                .translate([width/2.2,height/3]);
            var coordinates = projection(kyiv);
            svg.selectAll("circle")
                .data(kyiv)
                .enter()
                .append("circle")
                .attr("fill", function(d) {
                    //{"name":"м.Київ", "value":6530, "jur":4776},
                    return color(6530)
                })
                .attr("stroke", '#009688')
                .attr("r",function(d) { 
                    return 10
                })
                .attr("transform", function(d) { return "translate(" + coordinates + ")"; })
                .on("mouseover", function(d) {
                    tooltipBee.html(
                            '<h4>Київ</h4>'+
                            tooltip1+'6530</p>'+
                            tooltip2+'4776</p>'
                        )
                    
                    var dist = d3.select(this)
                    dist.attr("stroke", "black")
                        .attr("stroke-width", "1.5px")
                    return tooltipBee.style("visibility", "visible")
                })
                .on("mousemove", function() {
                    return tooltipBee.style("top", (d3.event.pageY-10)+"px").style("left",(d3.event.pageX+10)+"px");
                })
                .on("mouseout", function(d){
                    var dist = d3.select(this)
                    dist.attr("stroke", "#f5f5f5")
                        .attr("stroke-width", ".1px")
                    return tooltipBee.style("visibility", "hidden");
                })
            svg.selectAll("text")
                .data(kyiv)
                .enter()
                .append("svg:text")
                .html(function(d) {
                    if (width > 450) {
                        var returnValue = '<tspan>Київ</tspan>'+
                                '<tspan x="0" y="15">6 тис.</tspan>'
                    } else {
                        var returnValue = '<tspan  x="'+geoPath.centroid(d)[0]+'" y="'+geoPath.centroid(d)[1]+'">6 тис.</tspan>'
                    }
                    return returnValue
                })
                .attr("transform", function(d) { return "translate(" + (coordinates[0]+20)+','+(coordinates[1]-5) + ")"; })
                .attr("text-anchor","middle")
                .attr('font-family','Arial')
                .attr('fill','white')
                .attr("font-size",function(d) {
                    if (width > 450) {
                        return '12px'
                    } else {
                        return '10px'
                    }
                })
            g.selectAll("text")
                .data(ukraine.features)
                .enter()
                .append("svg:text")
                .html(function(d,i){
                    var name = d.properties['name']
                    var value = json.filter(k => k.name == name)[0].value
                    if (String(value) != 'null') {
                        if (width > 450) {
                            var returnValue = '<tspan  x="'+geoPath.centroid(d)[0]+'" y="'+geoPath.centroid(d)[1]+'">'+name.replace(' область', '')+"</tspan>"+
                                            "<tspan x='"+geoPath.centroid(d)[0]+"' y='"+(geoPath.centroid(d)[1]+15)+"'>"+String((value/1000).toFixed(0))+' тис.</tspan>'
                        } else {
                            var returnValue = '<tspan  x="'+geoPath.centroid(d)[0]+'" y="'+geoPath.centroid(d)[1]+'">'+String((value/1000).toFixed(0))+' тис.</tspan>'
                        }
                    } else {
                        var returnValue = 'Крим'
                    }
                    if (width > 450) {
                        if (name != 'Тернопільська область' && name != 'Івано-Франківська область'&& name != 'Київська область') {
                            return returnValue
                        }
                    } else {
                        return returnValue
                    }
                })
                .attr("x", function(d){
                    return geoPath.centroid(d)[0];
                })
                .attr("y", function(d){
                    return geoPath.centroid(d)[1]+5;
                })
                .attr("text-anchor","middle")
                .attr('font-family','Arial')
                .attr('fill',function(d) {
                    if (d.properties['name'] == 'Одеська область') {
                        return 'black'
                    } else if (json.filter(k => k.name == d.properties['name'])[0].value > 3000) {
                        return 'white'
                    } else {
                        return 'rgb(127,39,4)'
                    }
                })
                .attr("font-size",function(d) {
                    if (width > 450) {
                        return '12px'
                    } else {
                        return '10px'
                    }
                })
            
                
        }
        function makeColumnChart(id, w) { 
            if (w < 600) {
                var start_width = w
            } else {
                var start_width = 600
            } 
            d3.select("#"+id).html('')
            if (id == 'kved1') {
                var date = ["ІТ та телеком","Професійна діяльність","Логістика","Господарство","Переробна промисловість","Операції з нерухомістю","Будівництво","Охорона здоров'я та соц. допомога","Адм. та доп. обслуговування","Освіта"]
                var json = [18202,5300,2996,1371,877,836,737,608,572,234]
                var tooltipHtml = '<p>'
                var left = 240
                var id_height = 600
                var title = "Десять найбільших зростань кількості ФОП за категоріями"
            } else if (id == 'kved2') {
                var change_format = d3.format("")
                var date = ["Діяльність домашніх господарств","Готелі, ресторани і кафе","Інші види послуг","Відсутній вид екон. діяльності","Торгівля та ремонт авто і мотоциклів"]
                var json = [-20,-199,-566,-824,-4015]
                var tooltipHtml = '<p>'
                var left = 250
                var id_height = 420
                var title = 'Категорії ФОП, що показали падіння'
            } else if (id == 'kved3') {
                var change_format = d3.format("")
                var date = ["Збирання дикорослих недеревних продуктів","Перевезення речей","Лізинг інтелектуальної власності","Загальна середня освіта","Інша соціальна допомога","Догляд для осіб похилого віку та інвалідів","Інші фінансові послуги","Дизайн","Виробництво макаронів","Зв'язки із громадськістю"]
                var json = [31,22,20,18,17,17,16,15,14,14]
                var tooltipHtml = '<p>'
                var left = 300
                var id_height = 600
                var title = 'Десять найдинамічніших зростань кількості ФОП'
            } else if (id == 'kved4') {
                var change_format = d3.format("")
                var date = ["ТОВ","Благодійна організація","ГО","Фермерське господарство","Об'єднання співвласників багатоквартирного будинку"]
                var json = [8105,3592,1496,454,396]
                var tooltipHtml = '<p>'
                var left = 280
                var id_height = 420
                var title = 'Зростання кількості юр. осіб за організаційно-правовими формами'
            } else if (id == 'kved5') {
                var change_format = d3.format("")
                var date = ["Охорона здоров'я та соціальна допомога","Торгівля і ремонт т/с","Надання інших видів послуг","Сільське, лісове та рибне господарство","Переробна промисловість","Адміністративне та допоміжне обслуговування","Логістика","ІТ та телеком","Будівництво","Професійна діяльність"]
                var json = [3191,1035,298,292,271,185,176,154,121,86]
                var tooltipHtml = '<p>'
                var left = 315
                var id_height = 600
                var title = 'Зростання кількості юр. осіб за видами діяльності (ІІ квартал 2022-го)'
            } else if (id == 'kved6') {
                var change_format = d3.format("")
                var date = ["Соціальна допомога","Добування солі","Виробництво столових приборів","Діяльність екстериторіальних організацій","Роздрібна торгівля аудіо- та відеозаписами","Виробництво військових т/с","Виробництво товарів для власного споживання","Виробництво машин для виготовлення паперу","Ремонт повітряних і космічних літальних апаратів","Виробництво біжутерії"]
                var json = [19,12,9,9,8,6,6,5,5,4]
                var tooltipHtml = '<p>%'
                var left = 335
                var id_height = 600
                var title = 'Десять найдинамічніших зростань кількості юр. осіб (ІІ квартал 2022-го)'
            }
            if (start_width > 500) {
                var tickValue = 7
                var fontSize = '16px'
                var titleMargin = -140
            } else {
                var tickValue = 6
                var fontSize = '12px'
                var titleMargin = -170
            }
            var margin = {top: 40, right: 15, bottom: 70, left: left},  
                width = start_width - margin.left - margin.right,
                height = id_height - margin.top - margin.bottom;

            var svg = d3.select("#"+id)
                .append("svg")
                .attr("width", width + margin.left + margin.right)
                .attr("height", height + margin.top + margin.bottom)
                .append("g")
                .attr("transform",
                    "translate(" + margin.left + "," + margin.top + ")");
            svg.append("text")
                .text(title)
                .attr("x", function(){
                    var length = (start_width-this.getComputedTextLength())/2
                    
                    return -(left-length)
                }) 
                .attr("y", 0 - (margin.top / 2))
                .style("font-size", fontSize)
                .style("font-family", "Georgia")
                
            if (id == 'kved2') {
                var x = d3.scaleLinear()
                .domain([d3.min(json)-200,0])
                .range([width,0]);
            } else {
                var x = d3.scaleLinear()
                .domain([0, d3.max(json)])
                .range([ 0, width]);
            }
            

            svg.append("g")
                .attr("transform", "translate(0," + height + ")")
                .call(d3.axisBottom(x).ticks(4).tickFormat(function(x) {
                    if (id =='kved3' || id =='kved6') {
                        return x+'%'
                    } else {
                        return x
                    }
                }))
                .selectAll("text")
                .style("text-anchor", "middle");
            
            var tooltipBee = d3.select("body")
                .append("div")
                .style("position", "absolute")
                .style("z-index", "10")
                .style("visibility", "hidden")
                .style("padding", "14px")
                .style("background-color", "white")
                .style("border", "1px solid #f5f5f5")
                .style("color", "black")
                .style("border-radius", "6px")
                .style("border-color", "black")
                .style("font", "12px sans-serif")
                .text("tooltip");

            // Add Y axis
            var y = d3.scaleBand()
                .range([ 0, height ])
                .domain(date)
                .padding(.1);
            svg.append("g")
                .call(d3.axisLeft(y))
                .attr('font-size','14px')
                .attr('font-family','Arial');
            
            var formatTime = d3.timeFormat("%d %B");
            
            svg.selectAll("mybar")
            .data(json)
            .enter()
            .append("rect")
                .attr("y", function(d,i) { return y(date[i]); })
                .attr("x", x(0) )
                .attr("width", function(d,i) { return x(json[i])})
                .attr("height", y.bandwidth())
                .attr('class','every_day')
                .attr("fill", "#006064")
                .on("mouseover", function(d,i) {
                    if (id =='kved3' || id =='kved6') {
                        tooltipBee.html('<p>'+date[i]+': '+numberWithSpaces(d) +'%')
                    } else {
                        tooltipBee.html('<p>'+date[i]+': '+numberWithSpaces(d))
                    }
                    tooltipBee.style("visibility", "visible")
                })
                .on("mousemove", function() {
                    return tooltipBee.style("top", (d3.event.pageY-10)+"px").style("left",(d3.event.pageX+10)+"px");
                })
                .on("mouseout", function(d){
                    return tooltipBee.style("visibility", "hidden");
                })
            svg.selectAll("mybar")
                .data(json)
                .enter()
                .append("svg:text")
                .text(function(d,i){
                    if (id =='kved3' || id =='kved6') {
                        return d+'%'
                    } else {
                        return d
                    }
                    
                })
                .attr("y", function(d,i) {
                    return y(date[i])+(y.bandwidth()/1.6); })
                .attr("x", function(d,i) { 
                    if (x(json[i]) < 55) {
                        return x(json[i])+20; 
                    } else{ 
                        return x(json[i])-25; 
                    }  
                })
                .attr("text-anchor","middle")
                .attr('font-family','Arial')
                .attr('fill',function(d,i) { 
                    if (x(json[i]) < 55) {
                        return 'black'
                    } else{ 
                        return 'white'
                    }  
                })
                .attr('font-size','14px');
        } 
        makeMap('veth',window.innerWidth)
        makeColumnChart('kved1',window.innerWidth)
        makeColumnChart('kved2',window.innerWidth)
        makeColumnChart('kved3',window.innerWidth)
        makeColumnChart('kved4',window.innerWidth)
        makeColumnChart('kved5',window.innerWidth)
        makeColumnChart('kved6',window.innerWidth)
        window.onresize = function(event) {
            makeMap('veth',window.innerWidth)
            makeColumnChart('kved1',window.innerWidth)
            makeColumnChart('kved2',window.innerWidth)
            makeColumnChart('kved3',window.innerWidth)
            makeColumnChart('kved4',window.innerWidth)
            makeColumnChart('kved5',window.innerWidth)
            makeColumnChart('kved6',window.innerWidth)
        };
    </script>
</body>
</html>