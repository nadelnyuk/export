
<!DOCTYPE html>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link href="https://fonts.googleapis.com/css?family=Roboto" rel="stylesheet">
<style>

body{
  max-width: 1200px;
  margin: 0px auto;
  font-family: 'roboto',sans-serif;
  color: #000;
  font-style: normal;
}

#container{
  position: relative;
  line-height: 1.6
}

#sections{
  width: 340px;
  
}

#sections > div{
  background: white;
  height: 80vh;
  padding-top: 60px;
}
#sections > div:last-child{
  margin-bottom: 30px;
}
#sections > div.graph-scroll-active{
  opacity: 1;
}

#graph{
  width: 600px;
  position: -webkit-sticky;
  position: sticky;
  top: 100px;
  float: right;
}
#graph_text {text-align: center;}

@media (max-width: 925px)  {
  #graph {
    width: 100%;
    margin-left: 0px;
    float: none;
    top: 120px;
  }

  #sections{
    width: auto;
    position: relative;
    margin: 0px auto;
  }

  #sections > div{
    background: rgba(255,255,255,.8);
    padding: 10px;
    box-shadow: -1px -1px 5px -1px rgb(0 0 0 / 19%), 3px 4px 5px 0px rgb(0 0 0 / 19%);
    margin-bottom: 80vh;
    height: 100%;
  }

}

.simple_container {max-width: 600px; margin: 0 auto; line-height: 1.6; font-size: 16px}
.simple_container h1 {font-weight: 400;
    font-size: 2.125em;
    line-height: 2.5rem;
    margin: 17px auto 21px;
    text-align: center;
}
a {
    color: #000;
    text-decoration: none;
    cursor: pointer;
}
.time {font-size: 12px}
.annotation-note-title {text-shadow:1px 1px 2px white, 0 0 1em white, 0 0 0.2em white;}
</style>
<body>
    <div id="scatter_area"></div>
    <div class="simple_container">
        <h1>Поезд мертвых на три километра. 50 000 украинцев погибли от COVID-19</h1>
    </div>
    <!-- <div id='first_picture' style="max-width: 800px; margin: 0 auto;"></div> -->
    <div id='first_picture' style="max-width: 1280px;"></div>
    <div class="simple_container">
        <p>26 мая в Украине умер 50 000 человек от коронавирусной инфекции. Украина стала 17 страной в мире, настолько пострадавшей от коронавируса. Чтобы добраться до этой грустной отметки, нашей стране понадобилось 440 дней. Первый человек от COVID-19 умер в Украине 12 марта 2020-го, тогда погибла 71-летняя жительница Радомышля.</p>
        <p>С тех пор каждый день умирало в среднем 114 человек. В 2021 году показатели намного хуже – 217 человек. Реальное количество жертв от коронавируса даже больше: в Академии наук считают показатель избыточной смертности (он показывает, насколько больше людей умерли по сравнению со средним значением за 2015-2019 годы). Всю осень и декабрь 2020 года избыточная смертность была от 16% до 33% ежемесячно или суммарно 50 343 человека. В январе этот показатель упал до 1%, в феврале увеличился до 6,4%, а в марте подскочил до 24,7% или суммарно 16 966 человек за три месяца 2021 года. Но и это лишь приблизительные подсчеты: член группы моделирования проблем, связанных с пандемией COVID-19 при Национальной академии наук Игорь Иванов оценивает, что полная смертность от пандемии в 2,2-2,6 раз выше, чем официальная статистика смертности от коронавируса.</p>
        <div id='deaths' style="max-width: 600px; margin: 0 auto; margin-top:20px"></div>
        <p>LIGA.net уже 450 дней подряд сообщает о количестве жертв от коронавируса в Украине. Мы привыкли к цифрам, когда говорят, что 50, 100, 300 человек погибли от COVID-19. Но мы не хотим привыкать и не считаем, что общество должно смириться с такой жертвой, хотя бы потому, что как минимум часть этих жертв можно было бы избежать, если бы государство было более подготовленным и компетентнее реагировало на угрозу.</p>
        <p>Поэтому мы решили превратить цифры статистики в осязаемые понятия, то с чем сталкиваемся каждый день. Так какой человеческий масштаб смертности от COVID-19 в Украине?</p>
    </div>
    <div id='container' class='container-1'>
        <div id='graph'></div>
        <div id='sections'>
            <div><p>Вот так выглядит карта смертности. Всего в Украине 460 городов (из-за российской оккупации есть статистика Национальной службы здоровья только по 397 городам). 8% всех умерших проживали в Киеве (или 5036 человек). Далее идут Харьков (1738), Днепр (1693), Одесса (1570). Но в пересчете на душу населения города-миллионники – это не самые смертоносные места в Украине.</p></div>
            <div><p>Намного хуже обстоят дела, например, в Черновицкой области. В городе Сторожинец с населением 14 000 человек погибло 49 человек. Это самый высокий показатель смертности на 1000 жителей – 3,95% (для сравнения в Киеве – 1,7%). Второе и третье самые "смертельные" места также в Черновицкой области – в городах Новоселице и Вижница: 3,57% и 3,32% погибших на 1000 жителей соответственно. </p></div>
            <div><p>Всего за 2020 год в Украине умерло 616 835 человек, это на 6% больше, чем годом ранее. COVID-19 в прошлом году унес жизни 18 533 человек – это пятая причина смерти. В 2021 году ситуация изменилась в худшую сторону.</p></div>
            <div><p>По данным за январь-март этого года, COVID-19 стал третьей причиной смертности украинцев после болезней кровообращения и рака (более поздних данных Госстат не опубликовал еще). При этом надо учитывать, что данные Госстата о количестве погибших от коронавируса больше, чем эта же статистика Минздрава. Так за три месяца 2021 года у Госстата погибли 15 040 украинцев, а у Минздрава – 14 145 человек.</p></div>
            <div><p>Апрель 2021-го стал самым плохим месяцем, за это время от COVID-19 погибло 11 260 человек. Это соизмеримо с потерями Украины за семь лет войны на Донбассе, которая унесла 13 000 человек. </p></div>
            <div><p>50 000 человеческих жизней. Сколько это? Это больше, чем студентов в самом большом украинском вузе.</p></div>
            <div><p>Это больше, чем проживало в Припяти на момент аварии на ЧАЭС, после чего за несколько дней эвакуировали 49 400 человек.</p></div>
            <div><p>Это почти соизмеримо с тем, сколько человек посетили Книжный арсенал в 2019 году в Киеве (57 000).</p></div>
            <div><p>Это больше, чем население 82% украинских городов.</p></div>
            <div><p>Стадион Олимпийский в Киеве вмещает 70 000 человек.</p></div>
            <div><p>Соответственно, 50 000 человек – больше двух третьих стадиона.</p></div>
            <div><p>После посещения стадиона представьте, что вы в метро. В одном вагоне киевского метрополитена помещается 330 человек.</p></div>
            <div><p>Чтобы перевезти 50 000 человек, заполнив их полностью, необходимо 152 вагона, а это 31 состав.</p></div>
        </div>
    </div>
    <div class="simple_container"><p>Можно бесконечно долго подбирать аналогии, показывающие, что 50 000 человеческих жизней, – это очень и очень много. Год назад казалось немыслимым, что число жертв будет измеряться десятками тысяч в Украине и миллионами в мире (3,4 млн погибших на 26 мая). Мы верим, что нам не придется делать проект на 100 000 смертей, и призываем вас ответственно относиться к своему здоровью и безопасности окружающих. COVID-19 – это самая смертоносная “неестественная” угроза, с которой столкнулась Украина со времен Второй мировой войны.</p></div>


</body>

<script src="d3v4+jetpack.js"></script>
<script src="graph-scroll.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
<script src="https://d3js.org/d3-geo-projection.v2.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/d3-annotation/2.5.1/d3-annotation.min.js" integrity="sha512-iBAeBWWWFb8HqSBcrqcz98iIpuVH1la39dEYHtyQ/pGpeCQTQVvLJOWAuhv2Q7JSHp9k7hWA7sGxU3hHJe+tFg==" crossorigin="anonymous"></script>

<script src="js/first_picture.js"></script>
<script src="js/barchart.js"></script>
<script src="js/render.js?2"></script>
<script src="js/train.js"></script>

<script>
    
    //createFirstPicture()
    var ukraine = getData('ukraine.json').features;
    
    var todayDateFormat = d3.timeFormat("%Y-%m-%d");
    var parseTodayDate = d3.timeParse("%Y-%m-%d");
    var dayMonth = locale.format("%d %B")
    var parseTime = d3.timeParse("%m/%d/%Y");
    //var covid_timeline = getData("https://api-covid19.rnbo.gov.ua/charts/main-data?mode=ukraine");
    var covid_timeline = getData("js/covid_timeline.json");
    
    var oldWidth = 0
    function render(){
        if (oldWidth == innerWidth) return
        oldWidth = innerWidth

        var width = height = d3.select('#graph').node().offsetWidth
        var r = 40

        width = getWidth(d3.select('#graph').node().offsetWidth),
        height = getHeight(d3.select('#graph').node().offsetWidth)
        makeColumnChart('deaths',width)
        var svg = d3.select('#graph').html('')
            .append('svg')
            .attrs({width: width, height: height})

        var gs = d3.graphScroll()
            .offset(500)
            .container(d3.select('.container-1'))
            .graph(d3.selectAll('container-1 #graph'))
            .eventId('uniqueId1') 
            .sections(d3.selectAll('.container-1 #sections > div'))
            .on('active', function(index){
                width = getWidth(d3.select('#graph').node().offsetWidth),
                height = getHeight(d3.select('#graph').node().offsetWidth)
                var realIndex = index
                //console.log('index:'+String(realIndex))
                var tooltipBee = d3.select("body")
                    .append("div")
                    .style("position", "absolute")
                    .attr('class','tooltip')
                    .style("z-index", "10")
                    .style("visibility", "hidden")
                    .style("padding", "14px")
                    .style("background-color", "white")
                    .style("border", "1px solid #f5f5f5")
                    .style("color", "black")
                    .style("border-radius", "6px")
                    .style("border-color", "black")
                    .style("font", "12px sans-serif")
                    .text("tooltip");
                if (index == 0) {
                    var ukraine_map = document.getElementsByClassName('ukraine_map')

                    if (ukraine_map.length == 0) {

                        var projection = getProjection(width,height)

                        var svg = d3.select(".container-1 #graph svg")
                        
                        svg.append("text")
                            .attr("x", (width / 2) ) 
                            .attr("y", 10)
                            .attr("text-anchor", "middle")
                            .attr("class", "title")
                            .attr("id", "head_title")
                            .style("font-size", '12px')
                            .style("font-family", 'sans-serif')
                            .text('Количество погибших от COVID-19 в городах Украины');
                        svg.append("text")
                            .attr("x", width-50) 
                            .attr("y", height-35)
                            .attr("text-anchor", "middle")  
                            .attr("class", "subtitle title")
                            .style("font-size", '10px')
                            .style("font-family", 'sans-serif')
                            .style("fill", "#9e9e9e")
                            .text('Данные: СНБО');
                        var g = svg.append("g").attr('class','ukraine_map');
                        
                        drawMap(g,projection)
                        
                        var radiusSize = getRadius(width,1)
                        
                        drawCircles(projection,radiusSize,1,tooltipBee)

                    } else {
                        var projection = getProjection(width,height)

                        var radiusSize = getRadius(width,1)
                        
                        var cities_mer_circles = document.getElementsByClassName('cities_mer')
                        if (cities_mer_circles.length == 0) {
                            drawCircles(projection,radiusSize,1)
                        }

                        function zoomed() {
                            
                            var svg = d3.select(".container-1 #graph svg")
                            d3.select(".container-1 #graph").style('top','100px')
                            var title = document.getElementsByClassName('title')
                            if (title.length == 0) {
                                svg.append("text")
                                    .attr("x", (width / 2) ) 
                                    .attr("y", 30)
                                    .attr("text-anchor", "middle")  
                                    .attr("class", "title")
                                    .style("font-size", '12px')
                                    .style("font-family", 'sans-serif')
                                    .text('Количество погибших от COVID-19 в городах Украины');
                                svg.append("text")
                                    .attr("x", width-50) 
                                    .attr("y", height-35)
                                    .attr("text-anchor", "middle")  
                                    .attr("class", "subtitle title")
                                    .style("font-size", '10px')
                                    .style("font-family", 'sans-serif')
                                    .style("fill", "#9e9e9e")
                                    .text('Данные: СНБО');
                            }
                            
                            var g = svg.select(".ukraine_map");
                            g.selectAll('path')
                                .attr('transform', d3.event.transform);
                            
                            var cities_mer = svg.select(".cities_mer");
                            cities_mer.selectAll(".container-1 circle")
                                .attr('transform', d3.event.transform);
                            
                            var radiusSize = getRadius(width,1)

                            cities_mer.selectAll(".container-1 circle")
                                .transition().duration(200)
                                .delay(function(d,i){ return i * 2 })
                                .attr("fill", '#4dd0e1')
                                .attr("stroke", "#00838f")
                                .attr("r",function(d) { return radiusSize(d.per1000) })

                        }
                        const zoom = d3.zoom()
                            .on('zoom', zoomed);
                            
                        mapZooming(1,zoom)
                        
                    }
                    
                } else if (realIndex == 1) {
                    var svg = d3.select(".container-1 #graph svg")
                    d3.selectAll(".bar_title").attr('opacity',0)
                    d3.selectAll(".subtitle").attr('opacity',0)
                    var dots = document.getElementsByClassName('death_reason')
                    if(dots.length != 0) {
                        d3.selectAll('.death_reason').transition().duration(1000).attr('opacity',0)
                    }
                    var projection = getProjection(width,height)
                    d3.selectAll(".title").transition().duration(500).style('opacity',0)
                    d3.select("#container #tooltip").html('')
                    var ukraine_map = document.getElementsByClassName('ukraine_map')
                        
                    if (ukraine_map.length == 1) {
                        var svg = d3.select(".container-1 #graph svg")
                        d3.select(".container-1 .ukraine_map").selectAll("path")
                            .transition().duration(250)
                            .delay(function(d,i){ return i * 10 })
                            .attr("fill", "#f5f5f5")
                            .attr("stroke", "#9e9e9e")
                    } else {
                        d3.select(".container-1 #graph svg").html('')
                        var svg = d3.select(".container-1 #graph svg")
                        var g = svg.append("g").attr('class','ukraine_map');

                        drawMap(g,projection)

                        var radiusSize = getRadius(width,2)
                        
                        drawCircles(projection,radiusSize,2)
                    }
                    
                    const zoom = d3.zoom()
                        .on('zoom', zoomed);

                    function zoomed() {
                        
                        var svg = d3.select(".container-1 #graph svg")
                        svg.attr('height',600)
                        if (window.innerWidth>450) {
                            d3.select(".container-1 #graph").style('top','0px')
                        } else {
                            d3.select(".container-1 #graph").style('top','10px')
                        }
                        
                        var g = svg.select(".ukraine_map");
                        g.attr('id','noclass')
                        g.selectAll('path')
                            .attr('transform', d3.event.transform);
                        
                        var cities_mer = svg.select(".cities_mer");
                        cities_mer.selectAll(".container-1 circle")
                            .attr('transform', d3.event.transform);

                        var values = export_json.map(d => d.per1000)

                        var color = d3.scaleThreshold()
                            .domain(makeDomain(0,d3.max(values),.4))
                            .range(["#fff5f0","#fee0d2","#fcbba1","#fc9272","#fb6a4a","#ef3b2c","#cb181d","#99000d"]);
                        
                        var radiusSize = getRadius(width,2)
                            
                        cities_mer.selectAll(".container-1 circle")
                            .transition().duration(100)
                            .delay(function(d,i){ return i * 2 })
                            .attr("r",function(d) { return radiusSize(d.per1000) })
                            .attr("stroke-width", ".4px")
                            .attr("stroke", function(d){ 
                                if (d.per1000 > 2) {
                                    return color(d.per1000+1)
                                } else {
                                    return 'none'
                                }
                            })
                            .attr("fill", function(d){ 
                                if (d.per1000 > 2) {
                                    return color(d.per1000)
                                } else {
                                    return 'none'
                                }
                            })
                    }

                    mapZooming(2,zoom)
                    
                } else if (realIndex == 2) {

                    var svg = d3.select(".container-1 #graph svg")
                    var cities_mer = svg.select(".cities_mer");
                    cities_mer.selectAll(".container-1 circle")
                            .transition().duration(250)
                            .delay(function(d,i){ return i * 1 })
                            .attr('r',0)
                            .attr('fill','none')
                            .attr('stroke','none')
                    cities_mer.selectAll(".container-1 circle")
                        .on("mouseover", function(d) {
                            tooltipBee.style("visibility", "hidden")
                        })
                        .on("mousemove", function() {
                            tooltipBee.style("visibility", "hidden")
                        })
                        .on("mouseout", function(d){
                            tooltipBee.style("visibility", "hidden");
                        });
                    var ukraine_map = document.getElementsByClassName('ukraine_map')
                    if (ukraine_map.length == 1) {
                        var svg = d3.select(".container-1 #graph svg")
                        d3.selectAll(".title").html('')
                        d3.select(".container-1 .ukraine_map").selectAll("path")
                            .transition().duration(250)
                            .delay(function(d,i){ return i * 10 })
                            .attr("fill", "none")
                            .attr("stroke", "none")
                        
                        var cities_mer = svg.select(".cities_mer");
                        cities_mer.selectAll(".cities_mer circle")
                            .transition().duration(250)
                            .delay(function(d,i){ return i * 1 })
                            .attr('r',0)
                            .attr('fill','none')
                            .attr('stroke','none')
                    } 
                    drawBarChart(width)
                    d3.selectAll("#graph").style('top','30px')
                    d3.selectAll(".death_reason").attr('opacity',1)
                    d3.selectAll(".bar_title").text('Причины смертей в Украине в 2020');
                    
                } else if (realIndex == 3) {
                    var svg = d3.select(".container-1 #graph svg")
                    svg.attr('height',window.innerHeight-50)
                    var olimp = document.getElementsByClassName('olimp')
                    if (olimp.length !=0 ) {
                        svg.select(".olimp").html('')
                    }
                    var dots = document.getElementsByClassName('death_dots')
                    if(dots.length != 0) {
                        d3.selectAll('.death_reason').attr('opacity',1)
                        d3.selectAll(".circles_index1")
                            .transition().duration(200)
                            .delay(function(d,i){ return i * 2 })
                            .attr("r", 0)
                        d3.selectAll(".index1 text")
                            .attr('opacity',0)
                        d3.selectAll(".circles_index0")
                            .transition().duration(200)
                            .delay(function(d,i){ return i * 2 })
                            .attr("r", 0)
                        d3.selectAll(".index0 text")
                            .attr('opacity',0)
                        d3.selectAll(".annotations")
                            .attr('opacity',0)
                            
                    }
                    var death_reason = document.getElementsByClassName('death_reason')
                    if(death_reason.length == 0) {
                        drawBarChart(width)
                    }
                    d3.selectAll('.death_reason').attr('opacity',1)
                    updateBarChart(window.innerWidth,winterData)
                    d3.selectAll("#graph").style('top','30px')
                    d3.selectAll(".bar_title").attr('opacity',1).text('Причины смертей в Украине в 2021');
                    
                } else if (realIndex == 4) {
                    var svg = d3.select(".container-1 #graph svg")
                    d3.selectAll(".bar_title").attr('opacity',0)
                    d3.selectAll(".subtitle").attr('opacity',0)
                    var dots = document.getElementsByClassName('death_reason')
                    if(dots.length != 0) {
                        d3.selectAll('.death_reason').transition().duration(1000).attr('opacity',0)
                    }
                    if (window.innerWidth < 900) {
                        d3.selectAll("#graph").style('top','40px')
                    } else {
                        d3.selectAll("#graph").style('top','10px')
                    }
                    var dots = document.getElementsByClassName('circles_index1')
                    if(dots.length == 0) {
                        drawDots(width,0)
                        drawDots(width,1)
                    } else {
                        d3.selectAll(".circles_index0")
                            .transition().duration(200)
                            .delay(function(d,i){ return i * 2 })
                            .attr("r", 4)
                        d3.selectAll(".index0 text")
                            .attr('opacity',1)
                        d3.selectAll(".circles_index1")
                            .transition().duration(200)
                            .delay(function(d,i){ return i * 2 })
                            .attr("r", 4)
                        d3.selectAll(".index1 text")
                            .attr('opacity',1)   
                        d3.selectAll(".annotations")
                            .attr('opacity',1)
                    }
                    
                    d3.selectAll(".circles_index2")
                        .transition().duration(200)
                        .delay(function(d,i){ return i * 2 })
                        .attr("r", 0)
                    d3.selectAll(".index2 text")
                        .attr('opacity',0)
                } else if (realIndex == 5) {
                    var svg = d3.select(".container-1 #graph svg")
                    /* if (window.innerWidth < 900) {
                        d3.selectAll("#graph").style('top','40px')
                    } else {
                        d3.selectAll("#graph").style('top','10px')
                    } */
                    d3.selectAll("#graph").style('top','10px')
                    var dots = document.getElementsByClassName('circles_index1')
                    if(dots.length == 0) {
                        drawDots(width,0)
                        drawDots(width,1)
                    } 
                    var dots = document.getElementsByClassName('circles_index2')
                    if(dots.length == 0) {
                        drawDots(width,2)
                    } else {
                        d3.selectAll(".circles_index2")
                        .transition().duration(200)
                        .delay(function(d,i){ return i * 2 })
                        .attr("r", 4)
                        d3.selectAll(".index2 text")
                        .attr('opacity',1)
                    }
                    d3.selectAll(".circles_index3")
                        .transition().duration(200)
                        .delay(function(d,i){ return i * 2 })
                        .attr("r", 0)
                    d3.selectAll(".index3 text")
                        .attr('opacity',0)
                } else if (realIndex == 6) {
                    var svg = d3.select(".container-1 #graph svg")
                    /* if (window.innerWidth < 900) {
                        d3.selectAll("#graph").style('top','40px')
                    } else {
                        d3.selectAll("#graph").style('top','10px')
                    } */
                    d3.selectAll("#graph").style('top','10px')
                    var dots = document.getElementsByClassName('circles_index1')
                    if(dots.length == 0) {
                        drawDots(width,0)
                        drawDots(width,1)
                        drawDots(width,2)
                    } 
                    var dots = document.getElementsByClassName('circles_index3')
                    if(dots.length == 0) {
                        drawDots(width,3)
                    } else {
                        d3.selectAll(".circles_index3")
                        .transition().duration(200)
                        .delay(function(d,i){ return i * 2 })
                        .attr("r", 4)
                        d3.selectAll(".index3 text")
                        .attr('opacity',1)
                    }
                    d3.selectAll(".circles_index4")
                        .transition().duration(200)
                        .delay(function(d,i){ return i * 2 })
                        .attr("r", 0)
                    d3.selectAll(".index4 text")
                        .attr('opacity',0)
                } else if (realIndex == 7) {
                    var svg = d3.select(".container-1 #graph svg")
                    /* if (window.innerWidth < 900) {
                        d3.selectAll("#graph").style('top','40px')
                    } else {
                        d3.selectAll("#graph").style('top','10px')
                    } */
                    d3.selectAll("#graph").style('top','10px')
                    var cities_mer = svg.select(".cities_mer");
                    cities_mer.selectAll(".container-1 circle")
                        .on("mouseover", function(d) {
                            tooltipBee.style("visibility", "hidden")
                        })
                        .on("mousemove", function() {
                            tooltipBee.style("visibility", "hidden")
                        })
                        .on("mouseout", function(d){
                            tooltipBee.style("visibility", "hidden");
                        });
                    var ukraine_map = document.getElementsByClassName('ukraine_map')
                    if (ukraine_map.length == 1) {
                        var svg = d3.select(".container-1 #graph svg")
                        d3.selectAll(".title").html('')
                        d3.select(".container-1 .ukraine_map").selectAll("path")
                            .transition().duration(250)
                            .delay(function(d,i){ return i * 10 })
                            .attr("fill", "none")
                            .attr("stroke", "none")
                        
                        var cities_mer = svg.select(".cities_mer");
                        cities_mer.selectAll(".container-1 circle")
                            .transition().duration(250)
                            .delay(function(d,i){ return i * 1 })
                            .attr('r',0)
                            .attr('fill','none')
                            .attr('stroke','none')
                    } 
                    
                    if (ukraine_map.length == 1) {
                        svg.select('.olimp').html('');
                        /* if (window.innerWidth < 900) {
                            d3.selectAll("#graph").style('top','40px')
                        } else {
                            d3.selectAll("#graph").style('top','10px')
                        } */
                        //d3.selectAll("#graph").style('top','10px')
                        drawDots(width,0)
                        drawDots(width,1)
                        drawDots(width,2)
                        drawDots(width,3)
                    }
                    /* if (window.innerWidth < 900) {
                        d3.selectAll("#graph").style('top','40px')
                    } else {
                        d3.selectAll("#graph").style('top','10px')
                    } */
                    d3.selectAll("#graph").style('top','10px')
                    var dots = document.getElementsByClassName('circles_index1')
                    if(dots.length == 0) {
                        drawDots(width,0)
                        drawDots(width,1)
                        drawDots(width,2)
                        drawDots(width,3)
                    } 
                    var dots = document.getElementsByClassName('circles_index4')
                    if(dots.length == 0) {
                        drawDots(width,4)
                    } else {
                        d3.selectAll(".death_dots circle")
                        .transition().duration(200)
                        .delay(function(d,i){ return i * 2 })
                        .attr("r", 4)
                        d3.selectAll(".death_dots text")
                        .attr('opacity',1)
                    }
                    d3.selectAll(".death_dots")
                        .attr('opacity',1)
                } else if (realIndex == 8){
                    var svg = d3.select(".container-1 #graph svg")
                    svg.attr('height',500)
                    var death_dots = document.getElementsByClassName('death_dots')
                    if (death_dots.length != 0 ) {
                        /* d3.selectAll(".death_dots circle")
                        .attr("r", 0) */
                        d3.selectAll(".death_dots")
                            .attr('opacity',0)
                        
                        d3.selectAll(".death_dots text")
                        .attr('opacity',0)
                    }
                    var olimp = document.getElementsByClassName('olimp')
                    if (olimp.length != 0 ) {
                        svg.select('.olimp').html('');
                    }
                    var projection = getProjection(width,height)
                        
                    var ukraine_map = document.getElementsByClassName('ukraine_map')
                    if (ukraine_map.length == 1) {
                        var svg = d3.select(".container-1 #graph svg")
                        d3.select(".container-1 .ukraine_map").selectAll("path")
                            .transition().duration(250)
                            .delay(function(d,i){ return i * 10 })
                            .attr("fill", "#f5f5f5")
                            .attr("stroke", "#9e9e9e")
                        
                    } else {
                        //d3.select(".container-1 #graph svg").html('')
                        var svg = d3.select(".container-1 #graph svg")
                        var g = svg.append("g").attr('class','ukraine_map');
                        drawMap(g,projection)
                    }
                    var radiusSize = getRadius(width,3)
                    
                    var cities_mer_circles = document.getElementsByClassName('cities_mer')
                    if (cities_mer_circles.length == 0) {
                        drawCircles(projection,radiusSize,3)  
                    }
                    
                    var cities_mer = svg.select(".cities_mer");
                    cities_mer.selectAll(".container-1 circle")
                        .transition().duration(100)
                        .delay(function(d,i){ return i * 2 })
                        .attr("r",function(d) {return radiusSize(d.pop) })
                        .attr("cx", function(d){ 
                                return projection([d.geometry.coordinates[0], d.geometry.coordinates[1]])[0] 
                            })
                        .attr("cy", function(d){ return projection([d.geometry.coordinates[0], d.geometry.coordinates[1]])[1] })
                        .attr("stroke", function(d){ 
                            if (d.pop <= 50000) {
                                return '#00838f'
                            } else {
                                return '#616161'
                            }
                        })
                        .attr("fill", function(d){ 
                            if (d.pop <= 50000) {
                                return '#4dd0e1'
                            } else {
                                return '#bdbdbd'
                            }
                        })
                    cities_mer.selectAll(".container-1 circle")
                        .on("mouseover", function(d) {
                            tooltipBee.html(
                                '<h4>'+d.id.split('_')[0]+', '+d.id.split('_')[1]+'</h4>'+
                                '<p>'+numberWithSpaces(d.pop)+' жителей</p>'+
                                '<p>'+numberWithSpaces(d.deaths)+' погибших</p>'+
                                '<p>'+numberWithSpaces(d.per1000)+' погибших на 1000 жителей</p>'
                                )
                            tooltipBee.style("visibility", "visible")
                        })
                        .on("mousemove", function() {
                            return tooltipBee.style("top", (d3.event.pageY-10)+"px").style("left",(d3.event.pageX+10)+"px");
                        })
                        .on("mouseout", function(d){
                            return tooltipBee.style("visibility", "hidden");
                        });
                      
                    
                    var radiusSize = getRadius(width,3)
                        
                    const zoom = d3.zoom()
                        .on('zoom', zoomed);

                    function zoomed() {
                        
                        var svg = d3.select(".container-1 #graph svg")
                        d3.select(".container-1 #graph").style('top','100px')
                        var g = svg.select(".ukraine_map");
                        g.selectAll('path')
                            .attr('transform', d3.event.transform);
                        
                        var cities_mer = svg.select(".cities_mer");
                        cities_mer.selectAll(".container-1 circle")
                            .attr('transform', d3.event.transform);

                    }
                    
                    mapZooming(3,zoom)
                    d3.selectAll("#head_title").attr('opacity',1).text('Города с населением меньше 50 000 человек');
                    
                } else if (realIndex == 9 || realIndex == 10) {
                    
                    var svg = d3.select(".container-1 #graph svg")
                    var cities_mer = svg.select(".cities_mer");
                    cities_mer.selectAll(".container-1 circle")
                        .on("mouseover", function(d) {
                            tooltipBee.style("visibility", "hidden")
                        })
                        .on("mousemove", function() {
                            tooltipBee.style("visibility", "hidden")
                        })
                        .on("mouseout", function(d){
                            tooltipBee.style("visibility", "hidden");
                        });
                    var ukraine_map = document.getElementsByClassName('ukraine_map')
                    if (ukraine_map.length == 1) {
                        var svg = d3.select(".container-1 #graph svg")
                        d3.selectAll(".title").html('')
                        d3.select(".container-1 .ukraine_map").selectAll("path")
                            .transition().duration(250)
                            .delay(function(d,i){ return i * 10 })
                            .attr("fill", "none")
                            .attr("stroke", "none")
                        
                        var cities_mer = svg.select(".cities_mer");
                        cities_mer.selectAll(".container-1 circle")
                            .transition().duration(250)
                            .delay(function(d,i){ return i * 1 })
                            .attr('r',0)
                            .attr('fill','none')
                            .attr('stroke','none')
                    } 
                    var trains = document.getElementsByClassName('train_g')
                    if(trains.length != 0) {
                        d3.selectAll('.train_g').html('')
                    }
                    var position = makeDomain(0,75,.13)
                    var innerCircleRadius = 40;
                    var outerCircleRadius = 60;
                    var olimp = document.getElementsByClassName('olimp')
                    if (olimp.length == 0) {
                        var group = svg.append("g").attr('class','olimp');
                    } else{
                        var group = svg.select('.olimp');
                    }
                    var originX = width/2;
                    
                    if (width < 400) {var originY = 160;var x1 = width/2 } else {var originY = 260;var x1 = width/2.2}
                    var minus = 0
                    var colorIndex = 0
                    
                    for (minus=1;minus<13;minus++) { 
                        position.forEach(function(d){
                            colorIndex+=1
                            var chairOriginX = originX + ((x1-(minus*10)) * Math.sin(d));
                            var chairOriginY = originY - ((x1-(minus*10)-25) * Math.cos(d));
                            if (realIndex == 10 && colorIndex < 4945) {var color = '#b71c1c'} else {var color = "#bdbdbd"}
                        group.append("circle")
                            .attr('cx',chairOriginX)
                            .attr('cy',chairOriginY)
                            .attr('class', 'stadium '+'stadium_row'+String(minus))
                            .attr('fill',color)
                            .style("opacity", 0)
                            .attr('r', 3)
                        })
                    }
                    if (realIndex == 9 || realIndex == 10) {
                        for (minus=1;minus<13;minus++) { 
                            d3.selectAll('.stadium_row'+String(minus))
                                .transition()
                                .delay(function(d,i){ return i *2 })
                                .duration(500)
                                .style("opacity", 1);
                        }
                    }
                } else if (realIndex >= 11) {
                    function drawTrain() {
                        var dataset = [-480,-360,-240,-120,0];
                        var svg = d3.select(".container-1 #graph svg")
                        var g = svg.append('g').attr('id','train_g')
                            
                        var scale = 0.195
                        d3.xml("https://cdn.jsdelivr.net/gh/liga-net/few-projects/50deaths/ukr%20subway.svg", function(xml) {  
                            var importedNode = document.importNode(xml.documentElement, true);
                            
                            g.selectAll("g")
                                .data(dataset)
                                .enter()
                                .append("g")
                                .attr('class','trains')
                                .attr("transform", function(d, i){ 
                                    return "translate(" + d + "," + 50   + ")"+"scale("+ scale +")";
                                })
                                .each(function(d, i){ 
                                    var plane = this.appendChild(importedNode.cloneNode(true)); 
                                    d3.select(plane).select("path").attr("fill", "blue");
                                })
                            d3.selectAll('.trains')
                                .transition()
                                .duration(1)
                                .attr("transform", function(d, i){ 
                                    return "translate(" + -200 + "," + 50   + ")"+"scale("+ scale +")";
                                })
                                .transition()
                                .duration(1000)
                                .attr("transform", function(d, i){ 
                                    return "translate(" + (i * (600 / dataset.length)) + "," + 50   + ")"+"scale("+ scale +")";
                                })
                            
                        });
                        
                    }
                    function animateTrain(timesValue) {
                        var dataset = [-480,-360,-240,-120,0];

                        var h = 200;
                        var svg = d3.select(".container-1 #graph svg")
                        var trains = document.getElementsByClassName('train_g')
                        if(trains.length == 0) {
                            var g = svg.append('g').attr('class','train_g')
                        } else{
                            var g = svg.select('.train_g')
                        }
                        d3.selectAll('.container-1 #graph svg .train_g')
                            .append('text')
                            .attr('id','graph_text')
                            .style('text-align','center')
                            .attr('x',50)
                            .attr('y','20')
                        
                        var scale = 0.195
                        d3.xml("https://cdn.jsdelivr.net/gh/liga-net/few-projects/50deaths/ukr%20subway.svg", function(xml) {  
                            var importedNode = document.importNode(xml.documentElement, true);
                            g.selectAll("g")
                                .data(dataset)
                                .enter()
                                .append("g")
                                .attr('class','trains')
                                .attr("transform", function(d, i){ 
                                    return "translate(" + -800 + "," + 50   + ")"+"scale("+ scale+")";
                                })
                                .each(function(d, i){ 
                                    var plane = this.appendChild(importedNode.cloneNode(true)); 
                                    d3.select(plane).select("path").attr("fill", "blue");
                                })
                            repeat()      
                        });
                        
                        function repeat(){
                            if (timesValue*330 < 50000) {
                                d3.selectAll('.trains')
                                    .transition()
                                    .duration(1)
                                    .attr("transform", function(d, i){ 
                                        return "translate(" + -800 + "," + 50   + ")"+"scale("+ scale +")";
                                    })
                                    .transition()
                                    .duration(2000)
                                    .attr("transform", function(d, i){ 
                                        return "translate(" + (i * (width / dataset.length)) + "," + 50   + ")"+"scale("+ scale +")";
                                    })
                                    .transition()
                                    .duration(800)
                                    .attr("transform", function(d, i){ 
                                        return "translate(" + (i * (width / dataset.length)+1000) + "," + 50   + ")"+"scale("+ scale +")";
                                    })
                                    .transition()
                                    .duration(1)
                                    .on("end", repeat)
                                timesValue += 1
                                if (timesValue != 0 && timesValue != -1) {
                                    d3.select('#graph_text').text(numberWithSpaces(timesValue*330)+' человек проехали в вагонах')
                                }   
                            } else {
                                d3.selectAll('.trains')
                                    .transition()
                                    .duration(1)
                                    .attr("transform", function(d, i){ 
                                        return "translate(" + -800 + "," + 50   + ")"+"scale("+ scale +")";
                                    })
                                    .transition()
                                    .duration(2000)
                                    .attr("transform", function(d, i){ 
                                        return "translate(" + (i * (width / dataset.length)) + "," + 50   + ")"+"scale("+ scale +")";
                                    })
                            }
                            
                        }
                    }
                    var olimp = document.getElementsByClassName('olimp')
                    var svg = d3.select(".container-1 #graph svg")
                    svg.attr('height',500)
                    if (olimp.length != 0) {
                        svg.select(".olimp").html('')
                    }
                    if (timesValue == null) { var timesValue = -1}
                    animateTrain(timesValue)
                } 
                    
            })

    d3.select('#source')
        .styles({'margin-bottom': window.innerHeight - 450 + 'px', padding: '100px'})
    }

    render()
    d3.select(window).on('resize', render)


</script>
