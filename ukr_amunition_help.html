<!DOCTYPE html>
<html>
<head>
	<title></title>
	<meta charset="UTF-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
	<meta name="viewport" content="width=device-width, initial-scale=1">
</head>

<body>
    <div style="text-align: center; font-size: 20px; margin-bottom: 10px;">Военная помощь Украине</div>
    <div style="text-align: center; font-size: 14px; color:#cecece; margin-bottom: 20px; max-width: 600px; margin:0 auto;">Если нужно, тут будет описание</div>
    <div id="world_map" style="margin: 0 auto; max-width: 600px;margin-top: 10px; "></div>
    <div id="barchart" style="margin: 0 auto; max-width: 600px;"></div>
    <div id="hor_chart" style="margin: 0 auto; max-width: 700px;"></div>
    
    
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
    <script src="https://d3js.org/d3.v4.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/topojson/3.0.0/topojson.min.js"></script>
    <script>
        
        function numberWithSpaces(x) {
            return x.toString().replace(/\B(?=(\d{3})+(?!\d))/g, " ");
        }
        const range = (start, stop, step = 1) =>
            Array(Math.ceil((stop - start) / step)).fill(start).map((x, y) => x + y * step)
        function makeDomain(min, max, step) {
            return range(min, max, step)
        }
        function getData(id){
            var value = $.ajax({ 
                url: id, 
                async: false
            }).responseJSON;
            return value;
        }
        
        var world = getData('world-topo.json')

        var world_data = [{"country":"US","value":4,"rus":"США","desc":"Более 1300 тонн вооружения и боеприпасов (в том числе Javelin и гранатометы SMAW-D)","delivery":"1"},
{"country":"US","value":5,"rus":"США","desc":"2 катера Island","delivery":"1"},
{"country":"US","value":5,"rus":"США","desc":"Вертолеты Ми-17","delivery":"0"},
{"country":"US","value":4,"rus":"США","desc":"Еще около 30 рейсов с вооружением и боеприпасами по 80 тонн в среднем.","delivery":"0"},
{"country":"United Kingdom","value":1,"rus":"Объединенное Королевство","desc":"Амуниция (в том числе бронежилеты и каски)","delivery":"1"},
{"country":"United Kingdom","value":5,"rus":"Объединенное Королевство","desc":"Военная техника","delivery":"1"},
{"country":"United Kingdom","value":4,"rus":"Объединенное Королевство","desc":"2 000 противотанковых гранатомета NLAW","delivery":"1"},
{"country":"United Kingdom","value":2,"rus":"Объединенное Королевство","desc":"30 бойцов спецназа для обучения украинских военных","delivery":"1"},
{"country":"Czechia","value":4,"rus":"Чехия","desc":"4 000 артиллерийских снарядов калибра 152 мм","delivery":"0"},
{"country":"Canada","value":2,"rus":"Канада","desc":"Расширение миссии инструкторов до 260 военных","delivery":"1"},
{"country":"Canada","value":1,"rus":"Канада","desc":"Средства индивидуальной защиты, разведки и логистического обеспечения","delivery":"1"},
{"country":"Canada","value":2,"rus":"Канада","desc":"Расширение миссии инструкторов до 400 военных","delivery":"0"},
{"country":"Lithuania","value":1,"rus":"Литва","desc":"490 бронежилетов и баллистические пояса","delivery":"1"},
{"country":"Lithuania","value":4,"rus":"Литва","desc":"Американские переносные зенитно-ракетные комплексы Stinger","delivery":"1"},
{"country":"Latvia","value":4,"rus":"Латвия","desc":"Американские переносные зенитно-ракетные комплексы Stinger","delivery":"0"},
{"country":"Latvia","value":1,"rus":"Латвия","desc":"Сухпайки","delivery":"0"},
{"country":"Latvia","value":1,"rus":"Латвия","desc":"Экипировка","delivery":"0"},
{"country":"Estonia","value":4,"rus":"Эстония","desc":"Javelin","delivery":"1"},
{"country":"Estonia","value":5,"rus":"Эстония","desc":"Полевой госпиталь типа Role 2","delivery":"1"},
{"country":"Estonia","value":4,"rus":"Эстония","desc":"гаубицы калибра 122 мм и боеприпасы к ним (однако нужно разрешение Германии и Финляндии)","delivery":"0"},
{"country":"Poland","value":4,"rus":"Польша","desc":"ПЗРК Piorun","delivery":"0"},
{"country":"Poland","value":4,"rus":"Польша","desc":"легкие пехотные минометы LMP-2017 калибра 60 мм","delivery":"0"},
{"country":"Poland","value":4,"rus":"Польша","desc":"ручные гранатометы RPG-40","delivery":"0"},
{"country":"Poland","value":4,"rus":"Польша","desc":"Беспилотники","delivery":"0"},
{"country":"Poland","value":4,"rus":"Польша","desc":"Боеприпасы","delivery":"0"},
{"country":"Germany","value":5,"rus":"Германия","desc":"Полевой госпиталь типа Role 2","delivery":"1"},
{"country":"Germany","value":1,"rus":"Германия","desc":"5 000 касок","delivery":"0"},
{"country":"Denmark","value":3,"rus":"Дания","desc":"22 млн евро на укрепление обороноспособности Украины","delivery":"0"},
{"country":"Belgium","value":3,"rus":"Бельгия","desc":"31 млн евро на укрепление обороноспособности Украины","delivery":"0"}]
        
        var all_countries = topojson.feature(world, world.objects.countries).features
        var all_countries = all_countries.map(d => d.properties.admin)
        
        function replaceCountry(k) {
            var country = world_data.filter(d => d['country'] == k)
            
            if (country.length == 0) {
                var replaced = k.replace('Democratic Republic of the Congo','Congo (Kinshasa)')
                            .replace('Republic of Congo','Congo (Brazzaville)')
                            .replace('Czech Republic','Czechia')
                            .replace('South Korea','Korea, South')
                            .replace('Macedonia','North Macedonia')
                            .replace('Myanmar','Burma')
                            .replace('Republic of Serbia','Serbia')
                            .replace('Taiwan','Taiwan*')
                            .replace('United Republic of Tanzania','Tanzania')
                            .replace('United States of America','US')
                var country = world_data.filter(d => d['country'] == replaced)
                
            } 
            return country
        }
        function makeWorldMap(id,w) {
            if (w < 600) {
                var width = w,
                height = w/1.3,
                scale = 170;
            } else {
                var width = 600,
                scale = 160
                height = 550;
            }   
            var projection = d3.geoMercator()
                .scale(scale)
                .rotate([30.32,0])
                .center([0, 40.96])
                .translate([width / 2, height / 1.7]);

            var geoPath = d3.geoPath()
                .projection(projection);
            
            d3.select("#"+id+"_map").html('')

            var svg = d3.select("#"+id+"_map").append("svg")
                .attr("width", width)
                .attr("height", height);
            const zoom = d3.zoom()
            .scaleExtent([1, 8])
            .on('zoom', zoomed);
            svg.call(zoom);
            function zoomed() {
            g
                .selectAll('path') // To prevent stroke width from scaling
                .attr('transform', d3.event.transform);
            }
            if (width > 500) {
                var fontSize = '18px'
            } else {
                var fontSize = '16px'
            }
            /* 
            svg.append("text")
                .attr("x", (width / 2) ) 
                .attr("y", 20)
                .attr("text-anchor", "middle")  
                .style("font-size", fontSize)
                .style("font-family", "Georgia")
                .text('Несчастные случаи на рабочем месте в Европе'); */
                
            var g = svg.append("g").attr('id','strana');
            var values = world_data.map(d => d.value)
            
            var color = d3.scaleThreshold()
                .domain([1,2,3,4,5])
                .range(["#57000E","#3B97EA","#186564","#A2155D","#F45261",'#132C51']);
            
           
            var topoMap = topojson.feature(world, world.objects.countries).features.filter(d => d.properties.admin != 'Antarctica' )
            g.selectAll("path")
                .data(topoMap)
                .enter()
                .append("path")
                .attr('id',function(d) {
                    var country = replaceCountry(d.properties.admin)
                    if (country.length>0 && country[0]['value'] > 0){
                        return country[0]['country'].replace(' ','')
                    } else {
                        return "none" 
                    }
                } )
                .attr("fill",'#eeeeee')
                .attr("stroke", 'white')
                .attr("stroke-width", '1px')
                .attr("d", geoPath )
                .attr("class", "countries")
                .on("mouseover", function(d) {
                    var country = replaceCountry(d.properties.admin)
                    if (country.length>0){
                        var country = country[0]
                        if (country['value'] > 0) {
                            var filt = world_data.filter(x => x.country == country.country)
                            var returnValue = filt.map(x => x.desc).join('</p><p>')
                            tooltipBee.html(
                                '<h4>'+country['rus']+'</h4><p>'+returnValue+'</p>'
                            )
                        } else {
                            tooltipBee.html(
                                '<h4>'+country['rus']+'</h4><p>В открытых источниках нет информации о предоставленной Украине помощи</p>'
                            )
                        }
                        
                    } else {
                        tooltipBee.html('<h4>'+d.properties.admin+'</h4><p>В открытых источниках нет информации о предоставленной Украине помощи</p>')
                    }
                    tooltipBee.style("visibility", "visible")
                    })
                .on("mousemove", function() {
                    return tooltipBee.style("top", (d3.event.pageY-10)+"px").style("left",(d3.event.pageX+10)+"px");
                })
                .on("mouseout", function(d){
                    return tooltipBee.style("visibility", "hidden");
                })
            function createGradient(idd) {
                var svg = d3.select('#'+idd.replace(' ',''));
                var g = d3.select('#strana');
                var svgDefs = g.append('defs');

                var mainGradient = svgDefs.append('linearGradient')
                    .attr('id', 'gradient_'+idd.replace(' ',''))
                    .attr("gradientTransform", "rotate(90)");;

                var filt = world_data.filter(d => d.country == idd)
                var offset = 100/filt.length
                filt.forEach(function(value,index) {
                    mainGradient.append('stop')
                        .attr('stop-color',color(value.value))
                        .attr('offset', String(offset*(index+1))+'%');
                })

                svg.style('fill','url(#gradient_'+idd.replace(' ','')+')')
            }

            
            var unique = [...new Set(world_data.map(v => v.country))]
        
            unique.forEach(function(value) {
                createGradient(value)
            })
            

            var tooltipBee = d3.select("body")
                .append("div")
                .style("position", "absolute")
                .style("z-index", "10")
                .style("visibility", "hidden")
                .style("padding", "14px")
                .style("background-color", "white")
                .style("border", "1px solid #f5f5f5")
                .style("color", "black")
                .style("border-radius", "6px")
                .style("border-color", "black")
                .style("font", "12px sans-serif")
                .text("tooltip");
            var keys = ['Амуниция', 'Военные инструктора', 'Деньги', 'Оружие и боеприпасы', 'Техника'];

            var colorLegend = d3.scaleThreshold()
                .domain(keys)
                .range(["#57000E","#3B97EA","#186564","#A2155D","#F45261",'#132C51']);

            var legendSvg = d3.select("#strana").append('g')
            
            var size = 10
            legendSvg.selectAll("mydots")
            .data(keys)
            .enter()
            .append("rect")
                .attr("x", (width/3))
                .attr("y", function(d,i){ return (height-150) + i*(size+5)}) 
                .attr("width", size)
                .attr("height", size)
                .style("fill", function(d){ return colorLegend(d)})
                
            legendSvg.selectAll("mylabels")
            .data(keys)
            .enter()
            .append("text")
                .attr("x", (width/3+2) + size*1.2)
                .attr("y", function(d,i){ return (height-147) + i*(size+5) + (size/2)}) 
                .attr('font-family','sans-serif')
                .attr('fill','black')
                .attr('font-size','10px')
                .text(function(d){ return d})
                .attr("text-anchor", "left")
                .style("alignment-baseline", "middle")
        }
        makeWorldMap('world',window.innerWidth)
        window.onresize = function(event) { 
            makeWorldMap('world',window.innerWidth)
        };
        /* svg.selectAll("text")
                .data(topojson.feature(world, world.objects.countries).features.filter(d => d.properties.admin != 'Antarctica'))
                .enter()
                .append("svg:text")
                    .text(function(d,i){
                        var country = replaceCountry(d.properties.admin)
                        if (country.length>0 && country[0]['value'] != 0){
                            return country[0]['value']
                        }
                    })
                    .attr("x", function(d){
                        var country = replaceCountry(d.properties.admin)
                        if (country.length>0 && country[0]['rus'] == "Франция") { 
                            return geoPath.centroid(d)[0]+40;
                        } else if (country.length>0 && country[0]['rus'] == "Норвегия") {
                            return 385;
                        }else {
                            return geoPath.centroid(d)[0];
                        }
                        
                    })
                    .attr("y", function(d){
                        var country = replaceCountry(d.properties.admin)
                        if (country.length>0 && country[0]['rus'] == "Франция") {
                            return geoPath.centroid(d)[1]-40;
                        }  else if (country.length>0 && country[0]['rus'] == "Норвегия") {
                            return 185;
                        } else {
                            return geoPath.centroid(d)[1];
                        }
                    })
                    .attr("text-anchor","middle")
                    .attr('font-family','sans-serif')
                    .attr('fill','black')
                    .attr('font-size','10px'); */
    </script>
</body>
</html>